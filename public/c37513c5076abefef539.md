---
title: C言語のアセンブリ言語コード化〜演習課題
tags:
  - C
  - assembly
private: true
updated_at: '2016-11-02T09:35:33+09:00'
id: c37513c5076abefef539
organization_url_name: null
slide: false
ignorePublish: false
---
# C言語のアセンブリ言語コード化〜演習課題

[C言語のアセンブリ言語コード化〜直観編](http://qiita.com/zacky1972/items/86741d1ac6939795784f)にしたがって，次のC言語のプログラム(フィボナッチ数)のアセンブリコードを生成しました。これを元に次の問題を解いてレポートしてください。

1. C言語のプログラムとアセンブリ言語のプログラムを，構文に沿って対応付けてください。記述方法はテキストを参考にしましょう。

2. プログラムの動作を実際にトレースして確かめてください。実行過程を説明する文章を書きましょう。

3. もしかすると私が変換したアセンブリ言語のコードに抜けや矛盾があったり，テキストに説明が足りなかったりするかもしれません。その場合は適切に修正・補足する案をレポートに記述してください。

### C言語コード

```c:fib.c
unsigned int fib(unsigned int n) {
	unsigned int x;
	if(n == 0) {
		x = 0;
	} else if(n == 1) {
		x = 1;
	} else {
		x = fib(n − 2) + fib(n − 1);
	}
	return x;
}

void main(void) {
	int p;
	p = fib(2);
	...
}
```

### メモリマップ(fib)

|アドレス|使い方|
|:------|:----|
|(IX-$02)|自動変数 x|
|(IX)    |以前のレジスタ IX の内容のバックアップ|
|(IX+$02)|サブルーチンfactからの復帰先のプログラムコードのアドレス|
|(IX+$04)|引数 n|

### メモリマップ(main)

|アドレス|使い方|
|:------|:----|
|(IX-$02)|自動変数 p|
|(IX)    |以前のレジスタIXの内容のバックアップ|
|(IX+$02)|サブルーチンmainからの復帰先のプログラムコードのアドレス|


```assembly:fib.s
fib:
	PUSH IX				;; IXの内容をスタックに転送します
						;; (SP-$1)にIXの上位8ビット
						;; (SP-$2)にIXの下位8ビットを代入し，
						;; SPを2減らします
	LD IX,SP			;; SPの内容をIXに転送します(実際には存在しない命令)
	SUB SP,$02			;; SPを2減らします(実際には存在しない命令)
	PUSH DE 			;; スタックにDEの内容を転送します
	LD HL,(IX+$04)		;; HLに(IX+$04)の内容を転送します(実際には存在しない命令)
	LD DE,$00			;; DEに0を代入します
	CP HL,DE 			;; HLとDEを比較します(実際には存在しない命令)
						;; (HLからDEを引くが結果は代入せずフラグのみが変化します)
	JP NZ,if_1_else		;; ゼロでなかった時にelse節にジャンプします
	LD HL,$00			;; HLに0を代入します
	LD (IX-$02),HL 		;; (IX-$02)にHLを転送します(実際には存在しない命令)
	JP if_1_exit		;; 無条件でif文の末尾にジャンプします
if_1_else:
	LD HL,(IX+$04)		;; HLに(IX+$04)の内容を転送します(実際には存在しない命令)
	LD DE,$01			;; DEに1を代入します
	CP HL,DE 			;; HLとDEを比較します(実際には存在しない命令)
	JP NZ,if_2_else		;; ゼロでなかった時にelse節にジャンプします
	LD HL,$01			;; HLに1を代入します
	LD (IX-$02),HL 		;; (IX-$02)にHLを転送します(実際には存在しない命令)
	JP if_2_exit		;; 無条件でif文の末尾にジャンプします
if_2_else:
	PUSH BC 			;; スタックにBCの内容を転送します 
	LD HL,(IX+$04)		;; HLに(IX+$04)の内容を転送します(実際には存在しない命令)
	LD DE,$02           ;; DEに2を代入します
	SUB HL,DE 			;; HLからDEを減算します
	PUSH HL 			;; HLの値をスタックに転送します
	CALL fib 			;; サブルーチン fib を呼び出します
	ADD SP,$02			;; SPを2増やします(実際には存在しない命令)
	LD BC,HL            ;; HLの値をBCに転送します
	LD HL,(IX+$04)		;; HLに(IX+$04)の内容を転送します(実際には存在しない命令)
	LD DE,$01			;; DEに1を代入します
	SUB HL,DE 			;; HLからDEを減算します
	PUSH HL 			;; HLの値をスタックに転送します
	CALL fib 			;; サブルーチン fib を呼び出します
	ADD SP,$02			;; SPを2増やします(実際には存在しない命令)
	ADD HL,BC 			;; HLにBCの値を加算します
	LD (IX-$02),HL 		;; (IX-$02)にHLを転送します(実際には存在しない命令)
	POP BC 				;; スタックからBCの値を転送します
if_2_exit:	
if_1_exit:
	POP DE 				;; スタックからDEに転送します
	LD SP,IX			;; IXの内容をSPに転送します
	POP IX				;; スタックからIXの内容を転送します
	RET					;; 復帰します(プログラムの終了)

main:
	PUSH IX				;; IXの内容をスタックに転送します
						;; (SP-$1)にIXの上位8ビット
						;; (SP-$2)にIXの下位8ビットを代入し，
						;; SPを2減らします
	LD IX,SP			;; SPの内容をIXに転送します(実際には存在しない命令)
	SUB SP,$02			;; SPを2減らします(実際には存在しない命令)
	LD HL,$02			;; HLに2を代入します
	PUSH HL				;; HLの内容をスタックに転送します
	CALL fib			;; サブルーチン fib を呼び出します
	ADD SP,$02			;; SPを2増やします(実際には存在しない命令)
	LD (IX-$02),HL		;; HLの内容を(IX-$02)に転送します(実際には存在しない命令)
	...
	LD SP,IX			;; IXの内容をSPに転送します
	POP IX				;; スタックからIXの内容を転送します
	RET					;; 復帰します(プログラムの終了)
```
